{% set push_to_releases_basename = "release-{}_{}_push_to_releases".format(branch, product) %}
-
    taskId: "{{ stableSlugId(push_to_releases_basename) }}"
    requires:
        {% for upstream_builder in artifact_completes_builders + artifact_partials_builders %}
        - {{ stableSlugId(upstream_builder) }}
        {% endfor %}
    reruns: 5
    task:
        provisionerId: aws-provisioner-v1
        workerType: opt-linux64
        created: "{{ now }}"
        deadline: "{{ now.replace(days=4) }}"
        expires: "{{ never }}"
        priority: "high"
        retries: 5
        routes:
            - tc-treeherder-stage.{{ branch }}.{{ revision_hash }}
        payload:
            maxRunTime: 7200
            # TODO - create specific image for this
            image: "kmoir/python-beet-runner@sha256:107711623239cc03148f39c1c2bbdce317d7e49be036c5ffb3c5a0322d18d828"
            command:
                - /bin/bash
                - -c
                - >
                  wget -O mozharness.tar.bz2 https://hg.mozilla.org/{{ repo_path }}/archive/{{ revision }}.tar.bz2/testing/mozharness &&
                  mkdir mozharness && tar xvfj mozharness.tar.bz2 -C mozharness --strip-components 3 && cd mozharness &&
                  python scripts/release/push-candidate-to-releases.py --product {{ product }} --version {{ version }} --build-number {{ buildNumber }} --bucket {{ beetmover_candidates_bucket }}
            env:
                DUMMY_ENV_FOR_ENCRYPT: "fake"
            encryptedEnv:
                - {{ encrypt_env_var(stableSlugId(push_to_releases_basename), now_ms,
                                   now_ms + 24 * 3600 * 1000, 'AWS_ACCESS_KEY_ID',
                                   beetmover_aws_access_key_id) }}
                - {{ encrypt_env_var(stableSlugId(push_to_releases_basename), now_ms,
                                   now_ms + 24 * 3600 * 1000, 'AWS_SECRET_ACCESS_KEY',
                                   beetmover_aws_secret_access_key) }}
        metadata:
            name: "[beetmover] {{ product }} {{ branch }} push to releases"
            description: "moves candidates artifacts to releases dir. also known as push to mirrors"
            owner: "release@mozilla.com"
            source: https://github.com/mozilla/releasetasks

        extra:
            {% if running_tests is defined %}
            task_name: "{{ push_to_releases_basename }}"
            {% endif %}
            signing:
               signature: {{ sign_task(stableSlugId(push_to_releases_basename), valid_for=4 * 24 * 3600) }}

            treeherderEnv:
                - staging
            treeherder:
                symbol: p2m
                groupSymbol: BM
                collection:
                    opt: true
                machine:
                    platform: linux64
                build:
                    platform: all
